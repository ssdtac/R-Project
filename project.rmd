```{r message=FALSE, include=FALSE, warning=FALSE}
library("ISLR") 
library("tidyverse") 
library("ggplot2")
```

First, read the dataset and clean it.

```{r include=FALSE, message=FALSE, warning=FALSE}
# this will have problems
basics = read_delim("./title_basics.tsv")

# so we drop incomplete rows to make it not
basics = drop_na(basics, genres)

# these should not have problems
ratings = read_tsv("./title_ratings.tsv")
crew = read_tsv("./title_crew.tsv")
```

Then merge data into single object and clean data based on our specifications. We want only movies with runtime over 10 minutes and under 250. This is to exclude shorts and single entries that account for multiple movies.

```{r include=FALSE, message=FALSE}
#good to keep dirty data to see if it made a difference
dirty_data = reduce(list(basics, ratings, crew), inner_join, by = 'tconst')

#REMOVE UNUSED DATA NOW IT HELPS A LOT
rm(basics, ratings, crew)

#clean the data
data = dirty_data %>% filter((runtimeMinutes > 10)&(runtimeMinutes!="\\N"))
data = data %>% filter(titleType == "movie")
less = data %>% filter(runtimeMinutes < 250)
```

```{r include=FALSE, message=FALSE}
# remove comment and run lines to generate data.
#modern_data = data %>% filter(startYear > 1990)
less_modern = less %>% filter(startYear > 1990)
```

# Descriptive data analysis

First, we wondered what the average rating for movies overall was, and what the distribution is like for movies made since 1990 ("modern" movies).

## Average Rating of Movies

```{r echo=FALSE, message=FALSE}
# histogram of ratings
ggplot(less, aes(x=averageRating)) + geom_density(color="blue", fill="dodgerblue")+ggtitle("Distribution of Ratings over all time") + scale_x_continuous(name="Rating", breaks=seq(0, 10, 1))+scale_y_continuous(name="Frequency of Rating", breaks=seq(0, 0.4, 0.05))

ggplot(less_modern, aes(x=averageRating)) + geom_density(color="blue", fill="dodgerblue")+ggtitle("Distribution of Ratings since 1990") + scale_x_continuous(name="Rating", breaks=seq(0, 10, 1))+scale_y_continuous(name="Frequency of Rating", breaks=seq(0, 0.4, 0.05))
```

As we can see, most common ratings for movies are about 6.5. The distribution almost changed none when made to reflect more modern movies. The only visible change is a slightly more spread average rating, the peak at 6.5 lowers a bit in the modern version and that is reflected throughout the rest of the graph

## Ratings based on Genre

We then wondered what the most and least popular genres are 
```{r echo=FALSE, message=FALSE}
data_genres = less %>% select(tconst, genres, averageRating) %>% separate_rows(genres, sep=",")
# remove musicals because fuck musicals
data_genres = data_genres%>% filter(genres!=("\\N") & genres!=("Game-Show") & genres!=("Talk-Show") & genres!=("Short")& genres!=("Reality-TV") & genres!="Music"& genres!="Musical")

ggplot(data_genres, aes(averageRating)) + geom_density()+ggtitle("Distribution of Ratings by genre") + scale_x_continuous(name="Rating", breaks=seq(0, 10, 2))+facet_wrap(~genres, scales='free_y')
```

This is what that graph looks like with a few of the main genres overlayed with each other

```{r echo=FALSE, message=FALSE}
temp = data_genres %>% filter(genres==c("Action","Comedy","Horror","Drama","Thriller","Fantasy","Crime"))
ggplot(temp, aes(averageRating, color=genres)) + geom_density()+ggtitle("Distribution of Ratings by Genre") + scale_x_continuous(name="Rating", breaks=seq(0, 10, 2))+scale_y_continuous(name="Proportion of all ratings", breaks=seq(0, 0.5, 0.1))
rm(temp)
```
From this we can learn that Horror is more disliked, and more varied in rating in general, and the most consistently liked genre is Drama. We can also conclude that the most 

### Bar Chart of Average Ratings

```{r echo=FALSE, message=FALSE}
avg = aggregate(data_genres$averageRating, list(data_genres$genres), FUN=mean)
ggplot(avg, aes(x=x, y=Group.1, fill=Group.1)) + geom_bar(stat="identity",) + ggtitle("Average Rating of each category") + labs(x="Average Rating", y="Genre") + theme(legend.position = "none")
rm(avg)
```
# Predictive Data Analysis

## Plotting Release Year Against Average Movie Rating

```{r echo=FALSE, message=FALSE}
ggplot(less, aes(x=startYear, y=averageRating)) + geom_point() + scale_x_discrete(name="Release Year", breaks=seq(1892, 2023, 10)) + scale_y_discrete(name="Average Rating")
```

This is sort of "cone shaped".This is caused by an increase in population variance over time. As times get more modern, there are simply more movies to give ratings. This causes slight problems for the progression of our analysis. 

It is possible to instead take the average of all ratings for all movies made in a given year and plot that against the year.

## Plotting Average Rating of ALL Movies for a year vs Release year

```{r echo=FALSE, message=FALSE}
avg = aggregate(less$averageRating, list(less$startYear), FUN=mean)
avg = avg %>% drop_na(x)
ggplot(avg, aes(x=Group.1, y=x)) + geom_point() + scale_x_discrete(name="Release Year", breaks=seq(1892, 2023, 10)) + scale_y_discrete(name="Average Rating")

```

These data are a lot easier to understand.

From this we can see that when movies were first tracked for ratings, they started out pretty low, then seemed to level off for about 100 years with a slight downward trend. Then recently, it seems the average has gone up at what looks like an exponential rate

## Ratings of Modern Movies over Time

```{r echo=FALSE, message=FALSE}
ggplot(avg %>% filter(Group.1>1989), aes(Group.1, x)) + geom_point() + scale_x_discrete(breaks=seq(1990,2023,2), name="Release Year") + labs(y="Average Movie Rating")
```

You can see here that for some reason modern movies seem to be on a trend upward in terms of average rating directly following around 2020. This could be because of the small number of movies that have come out in 2023 so far, but that would not accound for the abnormally high average movie rating for 2022.

```{r message=FALSE, include=FALSE}
# cleaning memory space
rm(avg)
```
## Finding the residuals of average rating plotted against start year

Of all the residuals  in the data set, these are their data

```{r echo=FALSE, message=FALSE}
model = lm(averageRating~startYear, data=less)
summary(residuals(model))
```
Now on to the R-squared values:
```{r echo=FALSE, message=FALSE}
show(paste('R-squared:', summary(model)$r.squared))
show(paste('Adjusted R-squared:', summary(model)$adj.r.squared))
rm(model)

```

As we can see, the adjusted R-squared value is 0.013, which implies that plotting these 2 variables against each other has almost no predictive validity. This makes sense if you think about it, and we will use this data regardless.

## Making a Naive Prediction

Using fitted values to make a prediction about the average rating of movies in the future, we can get the following graph:
```{r}

```

Add column numwriters

```{r include=FALSE, message=FALSE}
for(ind in 1:nrow(data)){
  test=toString(data[ind,"writers"])
  if(test=="\\N"){
    len=0
  }else{
    split1=str_split_1(test,",")
    len=length(split1)
  }
  data[ind,"numwriters"]=len
}
```

Plotting num writers/directors against rating (No correlation, but higher ratings on 0 writers)

```{r echo=FALSE, message=FALSE}
numWritersData = data %>% select(averageRating, numwriters)
gNumWritersData = numWritersData %>% group_by(numwriters)
gSumm = gNumWritersData %>% summarise(mean_rating=mean(averageRating))

ggplot(gSumm, aes(x=numwriters,y=mean_rating)) + geom_point()+ggtitle("Ratings compared with writers") + scale_x_discrete(name="Number of Writers", breaks=seq(0, 69, 1)) + scale_y_continuous(name="Average Rating", breaks=seq(0, 10, 1))
```

```{r include=FALSE, message=FALSE}
test = data[,9]
test = test %>% filter(genres != "\\N")

split = str_split_1(toString(test), ",")

split
```



